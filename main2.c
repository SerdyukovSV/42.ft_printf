#include "ft_printf.h"

char    *ft_strrev(char *src)
{
    char *dst;
    int i;
    int k;

    i = 0;
    k = 0;
    while (src[k])
        k++;
    if (!(dst = (char *)malloc(sizeof(char)* k + 1)))
        return (NULL);
    while (--k >= 0)
        dst[i++] = src[k];
    dst[i] = '\0';
    return (dst);
}

long double  power(long double nbr, int n)
{
    if (n == 0)
        return (1);
    if (n < 0)
        return (power(1.0/nbr, -n));
    return (nbr * power(nbr, n - 1));
}

char *get_bin(unsigned char c)
{
    int i;
    char *tmp;

    i = 0;
    if (!(tmp = (char *)malloc(sizeof(char)* 9)))
        return (NULL);
    while (c != 0)
    {
        tmp[i] = "01"[c % 2];
        c /= 2;
        i++;
    }
    while (i != 8)
        tmp[i++] = '0';
    tmp[i] = '\0';
    tmp = ft_strrev(tmp);
    return (tmp);
}

int get_exponent(char **exp, int len, int correct)
{
    int res;

    res = 0;
    while (len >= 0)
    {
        res += (**exp - 48) * (power(2, len));
        *exp += 1;
        len -= 1;
    }
    return (res - correct);
}

unsigned char    *get_mantisa(char **mant)
{
    int i;
    long double res;
    unsigned char *bin_str;

    i = -1;
    while (**mant != '\0' && i >= -61)
    {
        res += (**mant - 48) * (power(2, i));
        *mant += 1;
        i -= 1;
    }
    if (!(bin_str = (unsigned char *)malloc(sizeof(unsigned char) * 66 + 1)))
        return (NULL);
    i = 2;
    while (res && i <= 64)
    {
        res *= 10;
        bin_str[i] = (unsigned char)res;
        res -= (long double)bin_str[i];
        bin_str[i] += 48;
        i += 1;
    }
    bin_str[0] = '1';
    bin_str[1] = '.';
    bin_str[i] = '\0';
    printf("%s\n", bin_str);
    return (bin_str);
}

int *multiply_bigint(int *mant, int exp, int *len)
{
    int             *tmp;
    int             i;
    int             k;

    i = 0;
    k = 0;
    while (i < *len)
    {
        if (mant[i] == 46)
            i++;
        if (mant[i] > 9 && (i - 1) >= 0)
        {
            (mant[i - 1] == 46) ? (mant[i - 2] += mant[i] / 10) : (mant[i - 1] += mant[i] / 10);
            mant[i] = mant[i] % 10;
            i = -1;
        }
        else if (mant[i] > 9 && (i - 1) < 0)
        {
            if (!(tmp = (int *)malloc(sizeof(int) * (*len) + 1)))
                return (0);
            tmp[k++] = mant[i] / 10;
            tmp[k++] = mant[i] % 10;
            i++;
            while (k < (*len + 1))
                tmp[k++] = mant[i++];
            *len += 1;
            free(mant);
            mant = tmp;
            i = -1;
            k = 0;
        }
        i++;
    }
    i = 0;
    if (exp > 0)
    {
        while (i < *len)
        {
            if (mant[i] == 46)
                i++;
            mant[i] *= 2;
            i++;
        }
        return (multiply_bigint(mant, exp - 1, len));
    }
    return (mant);
}


int *multiply_bigint_2(int *mant, int exp, int *len)
{
    int             *tmp;
    int             i;
    int             k;

    i = *len;
    k = 0;
    // printf("\n");
    while (--i >= 0)
    {
        // if (mant[i] == 46)
        //     printf(".");
        /* else if (mant[i] > 9)
            printf("[%d]", mant[i]); */
        // else
        //     printf("%d", mant[i]);
        
        // if (mant[i] == 46)
        //     i--;
        if (mant[i] != 46 && mant[i] > 9 && (i - 1) >= 0)
        {
            // printf("\n%d\n", mant[i]);
            (mant[i - 1] == 46) ? (mant[i - 2] += mant[i] / 10) : (mant[i - 1] += mant[i] / 10);
            // mant[i - 1] += mant[i] / 10;
            mant[i] = mant[i] % 10;
        }
        else if (mant[i] != 46 && mant[i] > 9 && (i - 1) < 0)
        {
            int j = -1;
            // printf("\n");
            // while (++j < *len)
            // {
            //     if (mant[j] == 46)
            //         printf(".");
            //     else
            //         printf("%d", mant[j]);
            // }
            // printf("\nmant[%d] = %d\n", j-1, mant[j-1]);
            // printf("\nnew_array\n");
            if (!(tmp = (int *)malloc(sizeof(int) * (*len) + 1)))
                return (0);
            tmp[k++] = mant[i] / 10;
            tmp[k++] = mant[i] % 10;
            i = 0;
            while (++i < (*len))
            {
                tmp[k] = mant[i];
                // if (tmp[k] == 46)
                //     printf(".");
                // else
                    // printf("%d", tmp[k]);
                if (i == (*len -1))
                    tmp[k] = 0;
                k++;
            }
            *len += 1;
            free(mant);
            mant = tmp;
            i = *len;
            k = 0;
        }
    }
    
    i = 0;
    if (exp > 0)
    {
        while (i < *len)
        {
            if (mant[i] == 46)
                i++;
            mant[i] *= 2;
            i++;
        }
        return (multiply_bigint_2(mant, exp - 1, len));
    }
    return (mant);
}

int *get_mantisa_2(char **mant, int *len)
{
    int i;
    int k;
    int tmp;
    long double res[64];
    int *bin_dec;

    i = -1;
    k = 0;
    while (**mant != '\0' && i >= -64)
    {
        res[k] = (**mant - 48) * (power(2, i));
        *mant += 1;
        i -= 1;
        k++;
    }
    i += 1;
    if (!(bin_dec = (int *)malloc(sizeof(int) * (i * -1)+2)))
        return (NULL);
    bin_dec[0] = 1;
    bin_dec[1] = 46;
    *len = i*-1;
    i = 0;
    while (i < *len)
    {
        k = 2;
        while (res[i])
        {
            res[i] *= 10;
            tmp = (int)res[i];
            bin_dec[k] += tmp;
            res[i] -= (long double)tmp;
            k++;
        }
        bin_dec = multiply_bigint_2(bin_dec, 0, &k);
        i += 1;
    }
    k = -1;
    *len += 2;
    while (++k < *len)
    {
        if (bin_dec[k] == 46)
            printf(".");
        else
            printf("%d", bin_dec[k]);
    }
    // printf("\n%d\n", *len);
    
    return (bin_dec);
}

/*

1.999999999999999777955395074968691915273666381835937500000000000
1.999999999999999999891579782751449556599254719913005828857421875

0 111111111111110 1111111111111111111111111111111111111111111111111111111111111111
        15bit                                    64bit
*/

// (-1)Sign × (1 + Mantissa) × 2(Exponent adjusted);

int printf_f(double d)
{
    int     i;
    int     len;
    int     *tmp;
    char    *str_bin;

    unsigned char str[sizeof(double) + 1];
    if (!(str_bin = (char *)malloc(sizeof(char) * 100)))
        return (0);
    ft_memcpy(str, &d, sizeof(double));
    len = sizeof(double);
    while (--len >= 0)
        str_bin = ft_strcat(str_bin, get_bin(str[len]));
    printf("%s\n", str_bin);
    char sign = *str_bin == 1 ? '-' : '+';
    str_bin += 1;
    int exp = get_exponent(&str_bin, 10, 1023);
    unsigned char *cnvrs_bin = get_mantisa(&str_bin);
    printf("exp = %d\n", exp);
    // ft_putstr((const char *)cnvrs_bin);
    printf("\n");
    if(!(tmp = (int *)malloc(sizeof(int) * ft_strlen((const char *)cnvrs_bin))))
        return (0);
    len = -1;
    while (cnvrs_bin[++len])
        tmp[len] = (cnvrs_bin[len] != 46) ? (cnvrs_bin[len] - 48) : 46;
    printf("len = %d\n", len);
    tmp = multiply_bigint_2(tmp, exp, &len);
    printf("len = %d\n", len);
    i = -1;
    printf("\nft_printf:\n");
    while (i++ < len)
    {
        if (tmp[i] == 46)
            printf(".");
        else
            printf("%d", tmp[i]);
    }
    return (len);
}

int printf_lf(long double d)
{
    int     i;
    int     len;
    int     *tmp;
    char    *str_bin;

    unsigned char str[10 + 1];
    if (!(str_bin = (char *)malloc(sizeof(char) * 100)))
        return (0);
    ft_memcpy(str, &d, 10);
    len = 10;
    while (--len >= 0)
        str_bin = ft_strcat(str_bin, get_bin(str[len]));
    // printf("%s\n", str_bin);
    char sign = *str_bin == 1 ? '-' : '+';
    str_bin += 1;
    int exp = get_exponent(&str_bin, 14, 16383);
    str_bin += 1;
    int *bin_dec = get_mantisa_2(&str_bin, &len);

    printf("\nexp = %d\n\n", exp);

    bin_dec = multiply_bigint_2(bin_dec, exp, &len);

    i = -1;
    while (i++ < len)
    {
        if (bin_dec[i] == 46)
            printf(".");
        else
            printf("%d", bin_dec[i]);
    }
    return (len);
}

int main(void)
{
    double d = 0.42;
    long double d2 = 0.42;
    printf("\nft_printf_f:\n");
    printf_f(d);
    // printf("\nft_printf_lf:\n");
    // printf_lf(d2);

    printf("\n\nprintf:\n");
    printf("%.64Lf\n", d2);
    printf("\nft_strcmp = %d\n",ft_strcmp("1189731495357231765021263853030970205169063322294624200440323733891737005522970722616410290336528882853545697807495577314427443153670288434198125573853743678673593200706973263201915918282961524365529510646791086614311790632169778838896134786560600399148753433211454911160088679845154866512852340149773037600009125479393966223151383622417838542743917838138717805889487540575168226347659235576974805113725649020884855222494791399377585026011773549180099796226026859508558883608159846900235645132346594476384939859276456284579661772930407806609229102715046085388087959327781622986827547830768080040150694942303411728957777100335714010559775242124057347007386251660110828379119623008469277200965153500208474470792443848545912886723000619085126472111951361467527633519562927597957250278002980795904193139603021470997035276467445530922022679656280991498232083329641241038509239184734786121921697210543484287048353408113042573002216421348917347174234800714880751002064390517234247656004721768096486107994943415703476320643558624207443504424380566136017608837478165389027809576975977286860071487028287955567141404632615832623602762896316173978484254486860609948270867968048078702511858930838546584223040908805996294594586201903766048446790926002225410530775901065760671347200125846406957030257138960983757998926954553052368560758683179223113639519468850880771872104705203957587480013143131444254943919940175753169339392366881856189129931729104252921236835159922322050998001677102784035360140829296398115122877768135706045789343535451696539561254048846447169786893211671087229088082778350518228857646062218739702851655083720992349483334435228984751232753726636066213902281264706234075352071724058665079518217303463782631353393706774901950197841690441824738063162828586857741432581165364040218402724913393320949219498422442730427019873044536620350262386957804682003601447291997123095530057206141866974852846856186514832715974481203121946751686379343096189615107330065552421485195201762858595091051839472502863871632494167613804996319791441870254302706758495192008837915169401581740046711477877201459644461175204059453504764721807975761111720846273639279600339670470037613374509553184150073796412605047923251661354841291884211340823015473304754067072818763503617332908005951896325207071673904547777129682265206225651439919376804400292380903112437912614776255964694221981375146967079446870358004392507659451618379811859392049544036114915310782251072691486979809240946772142727012404377187409216756613634938900451232351668146089322400697993176017805338191849981933008410985993938760292601390911414526003720284872132411955424282101831204216104467404621635336900583664606591156298764745525068145003932941404131495400677602951005962253022823003631473824681059648442441324864573137437595096416168048024129351876204668135636877532814675538798871771836512893947195335061885003267607354388673368002074387849657014576090349857571243045102038730494854256702479339322809110526041538528994849203991091946129912491633289917998094380337879522093131466946149705939664152375949285890960489916121944989986384837022486672249148924678410206183364627416969576307632480235587975245253737035433882960862753427740016333434055083537048507374544819754722228975281083020898682633020285259923084168054539687911418297629988964576482765287504562854924265165217750799516259669229114977788962356670956627138482018191348321687995863652637620978285070099337294396784639879024914514222742527006363942327998483976739987154418554201562244154926653014515504685489258620276085761837129763358761215382565129633538141663949516556000264159186554850057052611431952919918807954522394649627635630178580896692226406235382898535867595990647008385687123810329591926494846250768992258419305480763620215089022149220528069842018350840586938493815498909445461977893029113576516775406232278298314033473276603952231603422824717528181818844304880921321933550869873395861276073670866652375555675803171490108477320096424318780070008797346032906278943553743564448851907191616455141155761939399690767415156402826543664026760095087523945507341556135867933066031744720924446513532366647649735400851967040771103640538150073486891798364049570606189535005089840913826869535090066783324472578712196604415284924840041850932811908963634175739897166596000759487800619164094854338758520657116541072260996288150123144377944008749301944744330784388995701842710004808305012177123560622895076269042856800047718893158089358515593863176652948089031267747029662545110861548958395087796755464137944895960527975209874813839762578592105756284401759349324162148339565350189196811389091843795734703269406342890087805846940352453479398080674273236297887100867175802531561302356064878709259865288416350972529537091114317204887747405539054009425375424119317944175137064689643861517718849867010341532542385911089624710885385808688837777258648564145934262121086647588489260031762345960769508849149662444156604419552086811989770240", "1189731495357231765021263853030970205169063322294624200440323733891737005522970722616410290336528882853545697807495577314427443153670288434198125573853743678673593200706973263201915918282961524365529510646791086614311790632169778838896134786560600399148753433211454911160088679845154866512852340149773037600009125479393966223151383622417838542743917838138717805889487540575168226347659235576974805113725649020884855222494791399377585026011773549180099796226026859508558883608159846900235645132346594476384939859276456284579661772930407806609229102715046085388087959327781622986827547830768080040150694942303411728957777100335714010559775242124057347007386251660110828379119623008469277200965153500208474470792443848545912886723000619085126472111951361467527633519562927597957250278002980795904193139603021470997035276467445530922022679656280991498232083329641241038509239184734786121921697210543484287048353408113042573002216421348917347174234800714880751002064390517234247656004721768096486107994943415703476320643558624207443504424380566136017608837478165389027809576975977286860071487028287955567141404632615832623602762896316173978484254486860609948270867968048078702511858930838546584223040908805996294594586201903766048446790926002225410530775901065760671347200125846406957030257138960983757998926954553052368560758683179223113639519468850880771872104705203957587480013143131444254943919940175753169339392366881856189129931729104252921236835159922322050998001677102784035360140829296398115122877768135706045789343535451696539561254048846447169786893211671087229088082778350518228857646062218739702851655083720992349483334435228984751232753726636066213902281264706234075352071724058665079518217303463782631353393706774901950197841690441824738063162828586857741432581165364040218402724913393320949219498422442730427019873044536620350262386957804682003601447291997123095530057206141866974852846856186514832715974481203121946751686379343096189615107330065552421485195201762858595091051839472502863871632494167613804996319791441870254302706758495192008837915169401581740046711477877201459644461175204059453504764721807975761111720846273639279600339670470037613374509553184150073796412605047923251661354841291884211340823015473304754067072818763503617332908005951896325207071673904547777129682265206225651439919376804400292380903112437912614776255964694221981375146967079446870358004392507659451618379811859392049544036114915310782251072691486979809240946772142727012404377187409216756613634938900451232351668146089322400697993176017805338191849981933008410985993938760292601390911414526003720284872132411955424282101831204216104467404621635336900583664606591156298764745525068145003932941404131495400677602951005962253022823003631473824681059648442441324864573137437595096416168048024129351876204668135636877532814675538798871771836512893947195335061885003267607354388673368002074387849657014576090349857571243045102038730494854256702479339322809110526041538528994849203991091946129912491633289917998094380337879522093131466946149705939664152375949285890960489916121944989986384837022486672249148924678410206183364627416969576307632480235587975245253737035433882960862753427740016333434055083537048507374544819754722228975281083020898682633020285259923084168054539687911418297629988964576482765287504562854924265165217750799516259669229114977788962356670956627138482018191348321687995863652637620978285070099337294396784639879024914514222742527006363942327998483976739987154418554201562244154926653014515504685489258620276085761837129763358761215382565129633538141663949516556000264159186554850057052611431952919918807954522394649627635630178580896692226406235382898535867595990647008385687123810329591926494846250768992258419305480763620215089022149220528069842018350840586938493815498909445461977893029113576516775406232278298314033473276603952231603422824717528181818844304880921321933550869873395861276073670866652375555675803171490108477320096424318780070008797346032906278943553743564448851907191616455141155761939399690767415156402826543664026760095087523945507341556135867933066031744720924446513532366647649735400851967040771103640538150073486891798364049570606189535005089840913826869535090066783324472578712196604415284924840041850932811908963634175739897166596000759487800619164094854338758520657116541072260996288150123144377944008749301944744330784388995701842710004808305012177123560622895076269042856800047718893158089358515593863176652948089031267747029662545110861548958395087796755464137944895960527975209874813839762578592105756284401759349324162148339565350189196811389091843795734703269406342890087805846940352453479398080674273236297887100867175802531561302356064878709259865288416350972529537091114317204887747405539054009425375424119317944175137064689643861517718849867010341532542385911089624710885385808688837777258648564145934262121086647588489260031762345960769508849149662444156604419552086811989770240"));
}